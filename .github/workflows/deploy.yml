name: Deploy AI Calendar

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to production server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        timeout: 300s
        script: |
          cd "/media/arman/Local Disk/Projects/AIcalendar/ai-calendar"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $(git branch --show-current)"
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $(git log -1 --oneline)"
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git fetch origin main
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          BEHIND=$(git rev-list HEAD..origin/main --count)
          if [ "$BEHIND" -eq 0 ]; then
            echo "–ù–µ—Ç –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è"
            exit 0
          fi
          
          echo "–ù–∞–π–¥–µ–Ω–æ $BEHIND –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤. –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ..."
          
          # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ main –∏ –ø–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git checkout main
          git pull origin main
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
          git log -3 --oneline
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
          docker-compose down
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
          echo "–û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker system prune -f
          
          # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
          echo "–°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker-compose build --no-cache --parallel
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
          docker-compose up -d
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          echo "–ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 15
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
          docker-compose ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend:"
          docker-compose logs --tail=10 backend
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º nginx
          if systemctl is-active --quiet nginx; then
            echo "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx..."
            sudo nginx -t && sudo systemctl reload nginx || echo "–û—à–∏–±–∫–∞ nginx, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          fi
          
          echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"

    - name: Notify on success
      if: success()
      run: |
        echo "üéâ Deployment completed successfully!"
        echo "Deployed commit: ${{ github.sha }}"
        echo "Time: $(date)"

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "Failed commit: ${{ github.sha }}"
        echo "Please check the logs above"
